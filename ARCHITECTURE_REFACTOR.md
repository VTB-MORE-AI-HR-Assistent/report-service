# PDF API Architecture Refactor

## Обзор изменений

Проведен рефакторинг PDF API в соответствии с принципами Clean Architecture. Код разделен на контроллеры, сервисы и репозитории для лучшей организации и тестируемости.

## Новая архитектура

### 1. **Контроллеры (Controllers)**

- **`PdfController`** (`/api/v1/pdf/*`) - Основной контроллер для PDF операций
- **`LegacyPdfController`** (`/api/legacy/reports/*`) - Устаревшие эндпоинты (deprecated)
- **`ReportController`** - Обновлен для использования нового PDF сервиса

### 2. **Сервисы (Services)**

- **`PdfService`** - Интерфейс для PDF операций
- **`PdfServiceImpl`** - Реализация PDF сервиса с улучшенной логикой
- **`ReportService`** - Существующий сервис для работы с отчетами

### 3. **DTO (Data Transfer Objects)**

- **`PdfRequestDTO`** - Запрос для генерации PDF с настройками
- **`PdfResponseDTO`** - Ответ с информацией о статусе PDF сервиса

## Новые эндпоинты

### Основные PDF эндпоинты (`/api/v1/pdf/`)

| Метод  | Эндпоинт                              | Описание                          |
| ------ | ------------------------------------- | --------------------------------- |
| `GET`  | `/api/v1/pdf/candidate/{candidateId}` | Скачать PDF отчета кандидата      |
| `POST` | `/api/v1/pdf/candidate`               | Генерация кастомного PDF отчета   |
| `GET`  | `/api/v1/pdf/test`                    | Тестовый PDF с примерными данными |
| `GET`  | `/api/v1/pdf/simple`                  | Простой тестовый PDF              |
| `GET`  | `/api/v1/pdf/debug`                   | Отладочная информация о PDF       |
| `GET`  | `/api/v1/pdf/status`                  | Статус PDF сервиса                |

### Устаревшие эндпоинты (`/api/legacy/reports/`)

| Метод | Эндпоинт                         | Статус     |
| ----- | -------------------------------- | ---------- |
| `GET` | `/api/legacy/reports/pdf`        | Deprecated |
| `GET` | `/api/legacy/reports/pdf/simple` | Deprecated |

## Улучшения архитектуры

### 1. **Разделение ответственности**

- Контроллеры отвечают только за HTTP обработку
- Сервисы содержат бизнес-логику
- DTO обеспечивают типизацию данных

### 2. **Интерфейсы и внедрение зависимостей**

- `PdfService` интерфейс для легкого тестирования
- Spring DI для управления зависимостями
- Четкое разделение между интерфейсом и реализацией

### 3. **Обработка ошибок**

- Централизованная обработка исключений
- Правильные HTTP статус коды
- Детальные сообщения об ошибках

### 4. **Расширяемость**

- Поддержка различных типов отчетов (FULL, SUMMARY, TECHNICAL)
- Настройки языка и включения дополнительных элементов
- Легкое добавление новых типов PDF

## Структура файлов

```
src/main/kotlin/com/vtb/report/
├── controller/
│   ├── PdfController.kt              # Новый PDF контроллер
│   ├── LegacyPdfController.kt        # Устаревший контроллер
│   └── ReportController.kt           # Обновленный контроллер отчетов
├── service/
│   ├── PdfService.kt                 # Интерфейс PDF сервиса
│   ├── impl/
│   │   └── PdfServiceImpl.kt         # Реализация PDF сервиса
│   └── ReportService.kt              # Существующий сервис отчетов
├── dto/
│   ├── PdfRequestDTO.kt              # DTO для PDF запросов
│   └── PdfResponseDTO.kt             # DTO для PDF ответов
└── model/
    ├── CandidateReport.kt            # Существующая модель
    └── CandidateRecommendation.kt    # Существующая модель
```

## Тестирование

### Автоматическое тестирование

```bash
./test-new-pdf-api.sh
```

### Ручное тестирование

```bash
# Простой PDF
curl -X GET "http://localhost:8085/api/v1/pdf/simple" -o simple.pdf

# Тестовый PDF
curl -X GET "http://localhost:8085/api/v1/pdf/test" -o test.pdf

# Статус сервиса
curl -X GET "http://localhost:8085/api/v1/pdf/status"

# Отладочная информация
curl -X GET "http://localhost:8085/api/v1/pdf/debug"
```

## Swagger документация

Обновлена Swagger документация (`swagger.json`) с:

- Новыми эндпоинтами
- Схемами для DTO
- Примерами запросов и ответов
- Помеченными устаревшими эндпоинтами

## Преимущества новой архитектуры

1. **Тестируемость** - Легко создавать unit тесты с моками
2. **Читаемость** - Четкое разделение ответственности
3. **Расширяемость** - Легко добавлять новые типы PDF
4. **Поддерживаемость** - Изменения в одном слое не влияют на другие
5. **Производительность** - Оптимизированная генерация PDF
6. **Безопасность** - Валидация входных данных через DTO

## Миграция

### Для существующих клиентов

- Старые эндпоинты `/api/v1/reports/pdf/*` продолжают работать
- Новые эндпоинты `/api/v1/pdf/*` предоставляют расширенный функционал
- Устаревшие эндпоинты помечены как deprecated

### Рекомендации

1. Используйте новые эндпоинты `/api/v1/pdf/*` для новых интеграций
2. Постепенно мигрируйте с устаревших эндпоинтов
3. Используйте `/api/v1/pdf/status` для мониторинга сервиса
4. Применяйте `/api/v1/pdf/debug` для отладки проблем
